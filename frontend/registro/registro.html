<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Rostro</title>
    <link rel="stylesheet" href="/static/registro/registro.css">
</head>
<body>
    <div class="header">
        <h1>Registro de Rostro</h1>
    </div>
    
    <div class="container">
        <div class="video-container">
            <video id="video" width="640" height="480" autoplay></video>
            <canvas id="canvas" width="640" height="480"></canvas>
        </div>
        
        <div class="detection-status">
            <div id="nombreDetectado">Esperando detección...</div>
        </div>
        
        <div class="controls">
            <div class="input-group">
                <input type="text" id="inputNombre" placeholder="Nombre para registrar">
            </div>
            <div class="button-group">
                <button onclick="registrarRostro()" class="btn">Registrar</button>
                <button onclick="borrarRostro()" class="btn btn-secondary">Borrar</button>
                <button onclick="toggleDeteccion()" id="btnToggleDeteccion" class="btn btn-secondary" style="position:absolute; top:20px; right:20px; z-index:10;">Ocultar detección</button>
                <button onclick="volverLobby()" class="btn">Volver</button>
            </div>
        </div>
    </div>

    <script>
        const video = document.getElementById("video");
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        const nombreDiv = document.getElementById("nombreDetectado");
        const inputNombre = document.getElementById("inputNombre");

        let detecciones = [];
        let ultimaAccion = null;
        let nombreParaRegistrar = "";
        let idParaRegistrar = "";

        let registroBuffer = [];
        let bufferStartTime = null;
        const BUFFER_DURATION = 4000; // 3 segundos
        const CONFIDENCE_THRESHOLD = 0.75; // 60% de frames deben coincidir

        // Estados para la verificación de movimiento facial
        let esperandoRegistro = false;
        let secuenciaMirada = ["frente", "izquierda", "derecha", "frente"];
        let posicionActual = 0;
        let ultimaPosicionCara = null;
        let tiempoEnPosicion = 0;

        function iniciarBufferRegistro() {
            registroBuffer = [];
            bufferStartTime = Date.now();
            esperandoRegistro = true;
            posicionActual = 0;
            nombreDiv.textContent = "Para registrarte, mira al frente...";
        }

        function volverLobby() {
            window.location.href = "/"; // O ajusta la ruta si tu lobby está en otra URL
        }

        function procesarBufferRegistro(nombre) {
            // Contar cuántos frames coinciden con el nombre
            const coincidencias = registroBuffer.filter(n => n === nombre).length;
            const confianza = coincidencias / registroBuffer.length;
            return confianza;
        }

        function detectarPosicionCabeza(coordenadas) {
            // Extraer coordenadas del rostro
            const [top, right, bottom, left] = coordenadas;
            
            // Calcular ancho del rostro
            const anchoRostro = right - left;
            
            // Calcular posición del centro del rostro respecto al canvas
            const centroRostro = left + (anchoRostro / 2);
            const centroPantalla = canvas.width / 2;
            
            // Determinar posición basada en la distancia del rostro respecto al centro
            const umbralDesplazamiento = anchoRostro * 0.15; // 15% del ancho del rostro
            
            if (centroRostro < centroPantalla - umbralDesplazamiento) {
                return "izquierda";
            } else if (centroRostro > centroPantalla + umbralDesplazamiento) {
                return "derecha";
            } else {
                return "frente";
            }
        }

        function avanzarSecuencia() {
            posicionActual++;
            if (posicionActual < secuenciaMirada.length) {
                nombreDiv.textContent = `Bien! Ahora mira hacia ${secuenciaMirada[posicionActual]}...`;
            } else {
                // Secuencia completada, proceder al registro
                nombreDiv.textContent = "¡Perfecto! Registrando tu rostro...";
                ultimaAccion = "registrar";
                esperandoRegistro = false;
            }
            tiempoEnPosicion = 0;
        }

        function registrarRostro() {
            const nombre = inputNombre.value.trim();
            if (nombre === "") {
                alert("Por favor ingresa un nombre para registrar.");
                return;
            }
            if (esperandoRegistro) {
                alert("Ya hay un registro en proceso. Espera a que termine.");
                return;
            }
            nombreParaRegistrar = nombre;
            idParaRegistrar = ""; // El backend asigna el id incremental
            iniciarBufferRegistro();
        }

        const ws = new WebSocket("ws://localhost:8000/ws");

        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                video.srcObject = stream;
            })
            .catch(err => {
                console.error("Cámara no disponible:", err);
                nombreDiv.textContent = "❌ No se pudo acceder a la cámara.";
            });

        let mostrarDeteccion = true;

        function toggleDeteccion() {
            mostrarDeteccion = !mostrarDeteccion;
            const btn = document.getElementById("btnToggleDeteccion");
            btn.textContent = mostrarDeteccion ? "Ocultar detección" : "Mostrar detección";
            const canvas = document.getElementById("canvas");
            canvas.style.display = mostrarDeteccion ? "block" : "none";
        }

        ws.onmessage = (event) => {
            detecciones = JSON.parse(event.data);
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            let nombreDetectado = "Nadie detectado";
            if (detecciones.length > 0) {
                detecciones.forEach(d => {
                    const [top, right, bottom, left] = d.coordenadas;
                    if (mostrarDeteccion) {
                        ctx.strokeStyle = "red";
                        ctx.lineWidth = 2;
                        ctx.strokeRect(left, top, right - left, bottom - top);
                        ctx.fillStyle = "green";
                        ctx.font = "18px Arial";
                        ctx.fillText(d.nombre, left + 5, top - 5);
                    }
                });
                nombreDetectado = detecciones.map(d => d.nombre).join(", ");
            }
            
            // Solo mostrar nombre detectado si no estamos en proceso de registro
            if (!esperandoRegistro) {
                nombreDiv.textContent = nombreDetectado;
            }
            
            // Lógica de secuencia de mirada para registro
            if (esperandoRegistro && detecciones.length > 0) {
                // Tomamos la primera cara detectada
                const primeraCara = detecciones[0];
                const posicionCara = detectarPosicionCabeza(primeraCara.coordenadas);
                
                // Verificar si coincide con la posición esperada
                if (posicionCara === secuenciaMirada[posicionActual]) {
                    tiempoEnPosicion += 200; // Incrementamos tiempo (asumiendo que este código se ejecuta cada 200ms aprox)
                    
                    // Mostrar progreso
                    const porcentaje = Math.min(100, Math.round((tiempoEnPosicion / 1000) * 100));
                    nombreDiv.textContent = `Mira hacia ${secuenciaMirada[posicionActual]}... ${porcentaje}%`;
                    
                    // Si mantuvo la posición durante 1 segundo
                    if (tiempoEnPosicion >= 1000) {
                        avanzarSecuencia();
                    }
                } else {
                    // Resetear el tiempo si se mueve fuera de la posición
                    tiempoEnPosicion = 0;
                    nombreDiv.textContent = `Mira hacia ${secuenciaMirada[posicionActual]}...`;
                }
                
                // Guardar la posición para la próxima comparación
                ultimaPosicionCara = posicionCara;
            }
        };

        setInterval(() => {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = canvas.toDataURL("image/jpeg");

            ws.send(JSON.stringify({
                image: imageData,
                accion: ultimaAccion,
                nombre: nombreParaRegistrar,
                id: idParaRegistrar
            }));

            // Reiniciar solo si se acaba de registrar
            if (ultimaAccion === "registrar") {
                ultimaAccion = null;
                nombreParaRegistrar = "";
                idParaRegistrar = "";
            }
        }, 1000);
    </script>
</body>
</html>
